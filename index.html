<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ensaamockups</title>
  <style>
    :root{--bg:#f7fafc;--card:#ffffff;--muted:#6b7280;--accent:#2563eb}
    *{box-sizing:border-box}
    body{font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:0; background:var(--bg); color:#111}
    .container{max-width:1100px;margin:28px auto;padding:20px}
    header{display:flex;gap:16px;align-items:center;margin-bottom:18px}
    header h1{font-size:20px;margin:0}
    p.lead{margin:0;color:var(--muted);font-size:14px}

    .grid{display:grid;grid-template-columns:1fr 360px;gap:18px}
    .card{background:var(--card);border-radius:10px;padding:14px;box-shadow:0 1px 4px rgba(2,6,23,0.06)}

    /* upload / instructions */
    .u-list{display:flex;flex-direction:column;gap:8px}
    .hint{font-size:13px;color:var(--muted)}

    /* search panel */
    .search input{width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:8px}
    .filters{display:flex;gap:8px;margin-top:10px;align-items:center}
    button{padding:8px;border-radius:8px;border:0px;background:white}
    select{padding:8px;border-radius:8px;border:1px solid;background:white}
    .count{font-size:13px;color:var(--muted)}

    /* list */
    .list{display:grid;gap:12px;margin-top:14px}
    .item{display:flex;gap:12px;align-items:flex-start}
    .thumb{width:84px;height:84px;border-radius:8px;background:#f3f4f6;display:flex;align-items:center;justify-content:center;overflow:hidden;border:1px solid #eef2f7}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .meta{flex:1}
    .meta .title{font-weight:600}
    .meta .small{font-size:13px;color:var(--muted);margin-top:6px}
    .tags{margin-top:8px;display:flex;flex-wrap:wrap;gap:6px}
    .tag{background:#f1f5f9;color:#0f172a;padding:6px 8px;border-radius:999px;font-size:12px}
    .actions{display:flex;flex-direction:column;gap:8px}
    .btn{padding:8px 10px;border-radius:8px;border:1px solid #e5e7eb;background:white;cursor:pointer}
    .btn-primary{background:var(--accent);color:white;border:none}

    footer{margin-top:18px;color:var(--muted);font-size:13px}

    @media (max-width:900px){.grid{grid-template-columns:1fr} .thumb{width:72px;height:72px}}

    /* Add overlay/modal styles */
    .overlay{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background:rgba(2,6,23,0.5);
      z-index:1000;
      opacity:0;
      pointer-events:none;
      transition:opacity .18s ease;
    }
    .overlay.show{opacity:1;pointer-events:auto;}
    .modal{
      background:var(--card);
      color:inherit;
      border-radius:12px;
      padding:18px;
      max-width:420px;
      width:90%;
      box-shadow:0 8px 30px rgba(2,6,23,0.25);
      text-align:left;
      position:relative; /* ajouté pour pouvoir positionner la croix */
    }
    .modal h2{margin:0 0 8px 0;font-size:18px}
    .modal p{margin:0 0 12px;color:var(--muted);font-size:14px}
    .modal-buttons{display:flex;gap:8px;justify-content:flex-end}
    .btn-donate{background:#10b981;color:white;border:none; text-decoration-line: none;}

    .close-btn{
      position:absolute;
      top:-10px;
      right:-10px;
      width:36px;
      height:36px;
      border-radius:999px;
      background:#fee2e2;
      color:#b91c1c;
      border:none;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      font-size:18px;
      line-height:1;
    }
    .close-btn:hover{background:#fecaca}

  </style>
</head>
<body>
  <div class="container">
    <header>
      <div style="flex:1">
        <h1>Ensaamockups</h1>
        <p class="lead">Ressources par des étudiants de l'ENSAAMA pour les étudiants</p>
      </div>
      <div style="text-align:right">
        <small style="color:var(--muted)">Les mockups sont sous licences CC BY 4.0 <BR> les PPD viennent de chez www.openprinting.org</small>
      </div>
    </header>

    <div class="grid">
      <!-- left: list -->
      <div>
        <div class="card">
          <div class="search">
            <input id="searchInput" placeholder="Rechercher par mot-clé (ex: 60x40 métro)" />
            <div class="filters">
              <label for="typeSelect" style="font-size:13px;">Type:</label>
              <select id="typeSelect" class="select-fallback">
                <option value="all">Tous</option>
                <option value="ppd">PPD (imprimantes)</option>
                <option value="mockup">Mockup</option>
              </select>
              <div style="flex:1"></div>
              <div class="count" id="resultCount">0 résultats</div>
            </div>
          </div>

          <div class="list" id="resourceList">
            <!-- items inserted here -->
          </div>
        </div>
      </div>

      <!-- right: info / exemples -->
      <aside>
        <div class="card">
          <h3 style="margin:0 0 8px 0">C'est quoi un fichier PPD ?</h3>
          <div class="u-list">
            <div>
              <div class="hint">Un fichier PPD permet de crééer des imprimantes virtuels pour exporter notament depuis Indesign des PDFs correspondant parfairements aux caracteritiques des differetntes imprimantes</div>
              <div class="hint"><a href="https://youtu.be/BmT9HfGECGg?si=bRSkJ9fVmn6cuTzc">Tuto pour ajouter installer le fichier PPD</a></div>
              <div class="hint"><a href="https://www.youtube.com/watch?v=TD-w_AvbZ-s">Tuto pour exporter des cahier sur InDesign</a></div>
            </div>
        </div>
      </aside>
    </div>
  </div>

  <!-- Insert thank-you overlay -->
  <div id="thankYouOverlay" class="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="thanksTitle">
      <!-- croix de fermeture en haut à droite -->
      <button id="closeThanks" class="close-btn" type="button" aria-label="Fermer la fenêtre">&times;</button>

      <h2 id="thanksTitle">Merci pour le téléchargement !</h2>
      <p>Votre téléchargement a bien commencé. <br>Si ce mockup ou ce ficher vous est utile, pensez à faire <br>un don pour nous soutenir !</p>
      <div class="modal-buttons">
        <a href="https://buymeacoffee.com/valentinauger" target="_blank" rel="noopener" class="btn btn-primary btn-donate">Faire un don</a>
      </div>
    </div>
  </div>

  <script>

    const resources = [
      // small example PPD (texte)
      {
        id: 1,
        name: 'Imprimante virtuelle A3',
        type: 'ppd',
        tags: ['A3','A4','imprimante'],
        data: './VirtualPrinter_A3.ppd',
      },
      {
        id: 11,
        name: 'Affiche dans le métro',
        type: 'mockup',
        tags: ['.psd','métro','60x40','affiche'],
        preview: './affiche_metro.jpeg',
        data: './affiche_metro.psd'
      },
      {
        id: 12,
        name: 'Affiche dans la rue',
        type: 'mockup',
        tags: ['.psd','rue','60x40','affiche'],
        preview: './mockup_jcdecaux.jpeg',
        data: 'mockup_jcdecaux.psd'
      },
      {
        id: 13,
        name: 'Livre spirale',
        type: 'mockup',
        tags: ['.psd','livre','A4','éditorial'],
        preview: './livre_spirale.jpeg',
        data: 'livre_spirale.zip'
      },
    ];

    // ---------------- Utility functions ----------------
    function normalizeText(s){
      return (s||'').toString().normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase();
    }

    function matches(resource, queryTerms){
      if(!queryTerms || queryTerms.length===0) return true;
      const hay = [resource.name, resource.type, ...(resource.tags||[])].join(' ');
      const hayNorm = normalizeText(hay);
      return queryTerms.every(q => hayNorm.includes(normalizeText(q)));
    }

    function renderResources(list){
      const container = document.getElementById('resourceList');
      container.innerHTML = '';
      list.forEach(res => {
        const el = document.createElement('div');
        el.className = 'item';

        const thumb = document.createElement('div');
        thumb.className = 'thumb';
        if(res.type === 'mockup'){
          const img = document.createElement('img');
          img.src = res.preview;
          img.alt = res.name;
          thumb.appendChild(img);
        } else {
          thumb.innerHTML = '<?xml version="1.0" encoding="UTF-8"?><svg id="Calque_1" data-name="Calque 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 36"><defs><style>.cls-1 {fill: #9ca3af;}.cls-2 {isolation: isolate;}.cls-3 {fill: none;stroke: #9ca3af;stroke-miterlimit: 6;stroke-width: 1.8px;}</style></defs><rect class="cls-3" x="4.5" y="4.5" width="27" height="27" rx="3" ry="3"/><g class="cls-2"><path class="cls-1" d="M6.25,28.9v-1.51h1.51v1.51h-1.51Z"/><path class="cls-1" d="M8.8,28.9v-7.88h2.55c.97,0,1.6.04,1.89.12.45.12.83.38,1.13.77.3.4.46.91.46,1.54,0,.48-.09.89-.26,1.22-.18.33-.4.59-.67.78-.27.19-.55.31-.83.37-.38.08-.93.11-1.65.11h-1.04v2.97h-1.59ZM10.39,22.35v2.24h.87c.63,0,1.05-.04,1.26-.12.21-.08.38-.21.5-.39.12-.17.18-.38.18-.61,0-.29-.08-.52-.25-.71-.17-.19-.38-.3-.64-.35-.19-.04-.57-.05-1.14-.05h-.77Z"/><path class="cls-1" d="M15.62,28.9v-7.88h2.55c.97,0,1.6.04,1.89.12.45.12.83.38,1.13.77.3.4.46.91.46,1.54,0,.48-.09.89-.26,1.22-.18.33-.4.59-.67.78-.27.19-.55.31-.83.37-.38.08-.93.11-1.65.11h-1.04v2.97h-1.59ZM17.21,22.35v2.24h.87c.63,0,1.05-.04,1.26-.12.21-.08.38-.21.5-.39.12-.17.18-.38.18-.61,0-.29-.08-.52-.25-.71-.17-.19-.38-.3-.64-.35-.19-.04-.57-.05-1.15-.05h-.77Z"/><path class="cls-1" d="M22.44,21.02h2.91c.66,0,1.16.05,1.5.15.46.14.86.38,1.19.73s.58.77.75,1.28c.17.5.26,1.12.26,1.86,0,.65-.08,1.21-.24,1.68-.2.57-.48,1.04-.84,1.39-.28.27-.65.48-1.12.63-.35.11-.82.17-1.41.17h-2.99v-7.88ZM24.03,22.35v5.22h1.19c.44,0,.76-.03.96-.08.26-.06.47-.17.64-.33s.31-.41.42-.76c.11-.35.16-.83.16-1.44s-.05-1.08-.16-1.4c-.11-.33-.26-.58-.45-.76s-.44-.31-.74-.37c-.22-.05-.66-.08-1.31-.08h-.71Z"/></g></svg>';
        }

        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.innerHTML = `<div class="title">${res.name}</div><div class="small">Type: ${res.type.toUpperCase()}</div>`;

        const tags = document.createElement('div');
        tags.className = 'tags';

        (res.tags||[]).forEach(t => {
          const s = document.createElement('button');
          s.type = 'button';
          s.className = 'tag';
          s.textContent = t;
          s.title = `Ajouter "${t}" à la recherche`;
          s.addEventListener('click', () => addTagToSearch(t));
          tags.appendChild(s);
        });
        meta.appendChild(tags);

        const actions = document.createElement('div');
        actions.className = 'actions';
        const dl = document.createElement('button'); dl.className='btn btn-primary'; dl.textContent='Télécharger';
        dl.onclick = ()=> downloadResource(res);
        actions.appendChild(dl);

        el.appendChild(thumb); el.appendChild(meta); el.appendChild(actions);

        container.appendChild(el);
      });

      document.getElementById('resultCount').textContent = list.length + (list.length>1? ' résultats':' résultat');
    }

    // Ajoute le mot-clé cliqué à la barre de recherche (évite doublons) et applique le filtre
    function addTagToSearch(tag){
      const input = document.getElementById('searchInput');
      const raw = input.value || '';
      const terms = raw.split(/[\s,;]+/).map(s=>s.trim()).filter(Boolean);
      if(!terms.includes(tag)){
        terms.push(tag);
        input.value = terms.join(' ');
        input.focus();
        applyFilters();
      } else {
        // si déjà présent, on fait juste focus et relance (utile si l'utilisateur souhaite)
        input.focus();
        applyFilters();
      }
    }

    // Replace downloadResource to show thank-you overlay after starting download
    function downloadResource(res) {
      const source = res.data;
      const filename = (res.data||'').split('/').pop();

      // Create anchor to trigger download
      const a = document.createElement('a');
      a.href = source;
      a.download = filename || '';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);

      // show thank-you overlay
      showThankYou();
    }

    // --- Confetti with fade helpers ---
    let _conf = { canvas: null, ctx: null, particles: [], raf: null, resizeHandler: null, startTime: 0 };

    function startConfetti(container) {
      if (_conf.canvas) return;
      const c = document.createElement('canvas');
      c.style.position = 'absolute';
      c.style.inset = '0';
      c.style.width = '100%';
      c.style.height = '100%';
      c.style.pointerEvents = 'none';
      container.appendChild(c);
      const ctx = c.getContext('2d');

      const resize = () => { c.width = c.clientWidth; c.height = c.clientHeight; };
      resize();
      window.addEventListener('resize', resize);

      const colors = ['#ef4444','#f97316','#f59e0b','#84cc16','#06b6d4','#7c3aed'];
      const particles = [];
      const count = Math.max(40, Math.min(140, Math.round((c.width * c.height) / 10000)));
      for (let i = 0; i < count; i++) {
        particles.push({
          x: Math.random() * c.width,
          y: Math.random() * -c.height,
          sx: (Math.random() - 0.5) * 2,
          sy: 1 + Math.random() * 3,
          size: 6 + Math.random() * 10,
          color: colors[Math.floor(Math.random() * colors.length)],
          rot: Math.random() * Math.PI * 2,
          spin: (Math.random() - 0.5) * 0.2,
          baseAlpha: 0.9 + Math.random() * 0.1
        });
      }

      const totalDuration = 5000; // ms
      const fadeDuration = 1000; // ms (last part fades out)
      _conf = { canvas: c, ctx, particles, raf: null, resizeHandler: resize, startTime: performance.now() };

      function render() {
        const now = performance.now();
        const elapsed = now - _conf.startTime;
        const fadeStart = totalDuration - fadeDuration;
        const fadeFactor = elapsed < fadeStart ? 1 : Math.max(0, 1 - (elapsed - fadeStart) / fadeDuration);

        ctx.clearRect(0, 0, c.width, c.height);
        for (let p of particles) {
          p.x += p.sx;
          p.y += p.sy;
          p.rot += p.spin;
          if (p.y > c.height + 20) {
            p.x = Math.random() * c.width;
            p.y = -10 - Math.random() * c.height * 0.3;
          }
          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate(p.rot);
          ctx.globalAlpha = p.baseAlpha * fadeFactor;
          ctx.fillStyle = p.color;
          ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size * 0.6);
          ctx.restore();
        }

        if (fadeFactor <= 0) {
          stopConfetti();
          return;
        }
        _conf.raf = requestAnimationFrame(render);
      }
      render();
    }

    function stopConfetti() {
      if (!_conf.canvas) return;
      cancelAnimationFrame(_conf.raf);
      window.removeEventListener('resize', _conf.resizeHandler);
      if (_conf.canvas.parentNode) _conf.canvas.parentNode.removeChild(_conf.canvas);
      _conf = { canvas: null, ctx: null, particles: [], raf: null, resizeHandler: null, startTime: 0 };
    }

    // show/hide overlay, start confetti and let it fade
    function showThankYou(){
      const o = document.getElementById('thankYouOverlay');
      if(!o) return;
      o.classList.add('show');
      o.setAttribute('aria-hidden','false');
      // start confetti inside the overlay
      startConfetti(o);
      clearTimeout(o._hideTimeout);
      // hide overlay after total duration (matching confetti lifecycle)
      o._hideTimeout = setTimeout(()=>hideThankYou(), 6000);
    }
    function hideThankYou(){
      const o = document.getElementById('thankYouOverlay');
      if(!o) return;
      o.classList.remove('show');
      o.setAttribute('aria-hidden','true');
      clearTimeout(o._hideTimeout);
      stopConfetti();
    }

    // close button and click outside to close (attache de façon défensive)
    const closeBtn = document.getElementById('closeThanks');
    if (closeBtn) closeBtn.addEventListener('click', hideThankYou);

    const overlayEl = document.getElementById('thankYouOverlay');
    if (overlayEl) {
      overlayEl.addEventListener('click', (e)=>{
        if(e.target && e.target.id === 'thankYouOverlay') hideThankYou();
      });
    }

    // fermeture au clavier (Escape)
    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Escape') hideThankYou();
    });

    function previewResource(res){
      if(res.type === 'mockup'){
        // Affiche l'image seule dans une nouvelle fenêtre
        const w = window.open('', '_blank');
        w.document.title = res.name;
        const img = w.document.createElement('img');
        img.src = res.preview;
        img.alt = res.name;
        img.style.maxWidth = '100vw';
        img.style.maxHeight = '100vh';
        img.style.display = 'block';
        img.style.margin = 'auto';
        w.document.body.style.background = '#222';
        w.document.body.style.display = 'flex';
        w.document.body.style.justifyContent = 'center';
        w.document.body.style.alignItems = 'center';
        w.document.body.style.height = '100vh';
        w.document.body.appendChild(img);
      } else {
        // show text PPD in a modal-like window
        const w = window.open('', '_blank');
        fetch(res.dataUrl).then(r=>r.text()).then(txt=>{
          w.document.title = res.name;
          const pre = w.document.createElement('pre');
          pre.textContent = txt;
          pre.style.whiteSpace='pre-wrap';
          pre.style.fontFamily='monospace';
          pre.style.padding='12px';
          w.document.body.appendChild(pre);
        });
      }
    }

    const preview = "./affiche_metro.jpeg";

    // Fonction pour afficher la prévisualisation
    function showMockupPreview(preview) {
      const previewImage = document.getElementById('previewImage');
      if (previewImage) {
        previewImage.src = preview; // Définit la source de l'image
      } else {
        console.error("L'élément de prévisualisation n'existe pas.");
      }
    }

    // Appel de la fonction avec l'URL de prévisualisation
    showMockupPreview(preview);

    // ---------------- Search logic ----------------
    function getQueryTerms(){
      const raw = document.getElementById('searchInput').value || '';
      // split by spaces, commas, semicolons
      return raw.split(/[\s,;]+/).map(s=>s.trim()).filter(Boolean);
    }

    function applyFilters(){
      const type = document.getElementById('typeSelect').value;
      const q = getQueryTerms();
      let filtered = resources.filter(r => {
        if(type !== 'all' && r.type !== type) return false;
        return matches(r, q);
      });
      renderResources(filtered);
    }

    document.getElementById('searchInput').addEventListener('input', applyFilters);
    document.getElementById('typeSelect').addEventListener('change', applyFilters);

    // initial render : affiche tout par défaut
    applyFilters();

    // Accessibility: allow Enter to clear search
    document.getElementById('searchInput').addEventListener('keydown', (e)=>{ if(e.key==='Escape'){document.getElementById('searchInput').value='';applyFilters();}});
  </script>
</body>
</html>
